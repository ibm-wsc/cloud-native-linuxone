
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../../images/pipelines-logo.png" rel="icon"/>
<meta content="mkdocs-1.1.2, mkdocs-material-7.0.6" name="generator"/>
<title>Configure Build and Test - Cloud Native LinuxONE Workshop</title>
<link href="../../assets/stylesheets/main.2c0c5eaf.min.css" rel="stylesheet"/>
<link href="../../assets/stylesheets/palette.7fa14f5b.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-174658170-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
</head>
<body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="preference" dir="ltr">
<script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#configure-petclinic-build-and-test-to-meet-your-organizations-requirements1">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Cloud Native LinuxONE Workshop" class="md-header__button md-logo" data-md-component="logo" href="../.." title="Cloud Native LinuxONE Workshop">
<img alt="logo" src="../../images/pipelines-logo.png"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Cloud Native LinuxONE Workshop
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Configure Build and Test
            
          </span>
</div>
</div>
</div>
<div class="md-header__options">
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" data-md-state="active" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</label>
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
</button>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/ibm-wsc/cloud-native-linuxone/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Cloud Native LinuxONE Workshop" class="md-nav__button md-logo" data-md-component="logo" href="../.." title="Cloud Native LinuxONE Workshop">
<img alt="logo" src="../../images/pipelines-logo.png"/>
</a>
    Cloud Native LinuxONE Workshop
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/ibm-wsc/cloud-native-linuxone/" title="Go to repository">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../..">
        Home
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../introduction/">
        Introduction
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../prerequisites/">
        Prerequisites
      </a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4">
        Build and Deploy Pet Clinic
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Build and Deploy Pet Clinic" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Build and Deploy Pet Clinic
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../build-and-deploy/build_overview/">
        Build and Deploy Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../build-and-deploy/upandrunning/">
        PetClinic Up and Running
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5">
        Configure PetClinic's Pipeline
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Configure PetClinic's Pipeline" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
          Configure PetClinic's Pipeline
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../configure_overview/">
        Configure Pipeline Overview
      </a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Configure Build and Test
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Configure Build and Test
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#petclinic-pipeline">
    PetClinic Pipeline
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ensure-mysql-database-deployed-for-each-run">
    Ensure MySQL Database Deployed for each Run
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#make-clean-image-from-s2i-build">
    Make Clean Image from S2I build
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#summary">
    Summary
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../runpipeline/">
        Configure Development Deployment
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6">
        Test and Promote Pet Clinic
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Test and Promote Pet Clinic" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
          Test and Promote Pet Clinic
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../application-promotion/promote_overview/">
        Test and Promote Overview
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../application-promotion/promote/">
        Promoting Application
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../application-promotion/git/">
        Integrating Git
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../application-promotion/action/">
        CI/CD in Action
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" id="__nav_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_7">
        Cleanup
        <span class="md-nav__icon md-icon"></span>
</label>
<nav aria-label="Cleanup" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_7">
<span class="md-nav__icon md-icon"></span>
          Cleanup
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../cleanup/full-cleanup/">
        Environment Cleanup
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../resources/">
        Other resources
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../proposechange/">
        Propose a change
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#petclinic-pipeline">
    PetClinic Pipeline
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ensure-mysql-database-deployed-for-each-run">
    Ensure MySQL Database Deployed for each Run
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#make-clean-image-from-s2i-build">
    Make Clean Image from S2I build
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#summary">
    Summary
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/ibm-wsc/cloud-native-linuxone/edit/main/docs/full-dev-pipeline/pipeline.md" title="Edit this page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"></path></svg>
</a>
<h1 id="configure-petclinic-build-and-test-to-meet-your-organizations-requirements1"><span class="enumerate-heading-plugin">7.</span> Configure PetClinic Build and Test to Meet your Organization's Requirements<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup><a class="headerlink" href="#configure-petclinic-build-and-test-to-meet-your-organizations-requirements1" title="Permanent link">¶</a></h1>
<p>Now that PetClinic is up and running on your <abbr title="(OpenShift Container Platform / OCP): an open source container application platform based on the Kubernetes container orchestrator for enterprise application development and deployment">OpenShift</abbr> cluster, it's time to add functionality to your pipeline to achieve basic integration and deployment when triggered. The <abbr title="(OpenShift Container Platform / OCP): an open source container application platform based on the Kubernetes container orchestrator for enterprise application development and deployment">OpenShift</abbr> pipeline you created in the <a href="../../build-and-deploy/upandrunning/">PetClinic Up and Running</a> uses <a href="https://tekton.dev" rel="noopener noreferrer" target="_blank">Tekton</a> to run a series of tasks (each with one or more steps) to accomplish a workflow (pipeline). You will use the Pipeline Builder <abbr title="user interface">UI</abbr> built into <abbr title="(OpenShift Container Platform / OCP): an open source container application platform based on the Kubernetes container orchestrator for enterprise application development and deployment">OpenShift</abbr> to quickly and easily craft a pipeline that meets your specific needs.</p>
<div class="admonition info">
<p class="admonition-title">Why <abbr title="(OpenShift Container Platform / OCP): an open source container application platform based on the Kubernetes container orchestrator for enterprise application development and deployment">OpenShift</abbr> Pipelines?</p>
<ul>
<li>
<p>Portable: <abbr title="(OpenShift Container Platform / OCP): an open source container application platform based on the Kubernetes container orchestrator for enterprise application development and deployment">OpenShift</abbr> resources defined via yaml files -&gt; portable across <abbr title="(OpenShift Container Platform / OCP): an open source container application platform based on the Kubernetes container orchestrator for enterprise application development and deployment">OpenShift</abbr> clusters</p>
</li>
<li>
<p>Low Resource Usage: Containers spin up when triggered -&gt; resources only used when needed</p>
</li>
<li>
<p>Configurable: Can tailor overall pipeline and individual tasks to needs of your enterprise/organization </p>
</li>
<li>
<p>Ease of Use: Pipeline Builder <abbr title="user interface">UI</abbr> and built-in cluster resources (i.e. <code>ClusterTasks</code>, <code>ClusterTriggerBindings</code>, etc.) enable you to easily create a pipeline and export the yaml files with minimal knowledge</p>
</li>
</ul>
</div>
<h2 id="petclinic-pipeline"><span class="enumerate-heading-plugin">7.1</span> PetClinic Pipeline<a class="headerlink" href="#petclinic-pipeline" title="Permanent link">¶</a></h2>
<p>When you deployed the PetClinic application using the <code>From Git</code> option in the <a href="../../build-and-deploy/upandrunning/">PetClinic Up and Running</a> section, you chose to create a basic pipeline. You'll start with this pipeline and edit it to add new functionality for your use case. </p>
<p>Navigate to the <code>Pipelines</code> tab in the <code>Developer</code> perspective on the left and then click the three dots to the right of the pipeline name (<code>spring-petclinic</code>) and choose <code>Edit Pipeline</code>. <img alt="Pipeline Image" src="../../images/Part1/EditNewPipeline.png"> </img></p>
<h2 id="ensure-mysql-database-deployed-for-each-run"><span class="enumerate-heading-plugin">7.2</span> Ensure MySQL Database Deployed for each Run<a class="headerlink" href="#ensure-mysql-database-deployed-for-each-run" title="Permanent link">¶</a></h2>
<p>This will bring you to the Pipeline Builder <abbr title="user interface">UI</abbr> where you can edit your pipeline. Here you will make sure the MySQL database is configured according to your specification before the <code>build</code> task.</p>
<ol>
<li>
<p>Add a <code>mysql-deploy</code> task in parallel to the <code>git-fetch</code> task. 
    <img alt="Add Parallel MySQL" src="../../images/Part1/mySQL_ParallelTask.png"> </img></p>
<div class="admonition info">
<p class="admonition-title">Why is <code>mysql-deploy</code> in Parallel?</p>
<p>This ensures MySQL is in place for each <code>PetClinic</code> application build (which would fail without it).  </p>
</div>
<p>Click <code>Select Task</code> in the middle of the rectangle of the new task and choose the <code>openshift-client</code> task from the dropdown menu. </p>
<p><img alt="ChooseOpenShift Client" src="../../images/Part1/Choose_OpenShiftClientTask.png"/></p>
<p>Click on the middle of the oval of the <code>openshift-client</code> task to enter values for it (copy and paste boxes below image).</p>
<p><img alt="Click OpenShift Client" src="../../images/Part1/OpenShiftClientOval.png"/></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Once you add a specific task (i.e. <code>openshift-client</code>), clicking on the oval of the task will enable you to edit its default values for your needs.</p>
</div>
<p>Give the task the following parameters to ensure the MySQL database is available with the necessary configuration:</p>
<p><img alt="MySQL Task" src="../../images/Part1/MySQLTemplateTask.png"/></p>
<p><strong>Display Name</strong></p>
<div class="highlight"><pre><span></span><code>mysql-deploy
</code></pre></div>
<p><strong>SCRIPT</strong></p>
<div class="highlight"><pre><span></span><code>oc process openshift//mysql-ephemeral -p <span class="nv">MYSQL_USER</span><span class="o">=</span>petclinic -p <span class="nv">MYSQL_PASSWORD</span><span class="o">=</span>petclinic -p <span class="nv">MYSQL_ROOT_PASSWORD</span><span class="o">=</span>petclinic -p <span class="nv">MYSQL_DATABASE</span><span class="o">=</span>petclinic <span class="p">|</span> oc apply -f -
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Simply Click Away</p>
<p>Once you have entered the string into the <code>SCRIPT</code> section, just click away (i.e. on a regular section of the page) to get the configuration menu to go away and keep the new value(s) you just entered for the task.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">What is <code>oc process</code> doing?</p>
<p><code>oc process</code> is processing the <a href="https://docs.openshift.com/container-platform/4.7/openshift_images/using-templates.html#templates-overview_using-templates" rel="noopener noreferrer" target="_blank"><abbr title="(OpenShift Container Platform / OCP): an open source container application platform based on the Kubernetes container orchestrator for enterprise application development and deployment">OpenShift</abbr> template</a> for the <code>mysql-ephemeral</code> database with the parameters given via a series of <code>-p</code> arguments and finally <code>oc apply -f -</code> ensures that any missing components will be recreated.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">No help please!</p>
<p>Make sure <code>help</code> is deleted from the <code>ARGS</code> section (it will be greyed out once deleted) or bad things will happen (i.e. the help screen will come up instead of the proper command running). </p>
</div>
</li>
<li>
<p>Add a <code>mysql-rollout-wait</code> task</p>
<p>You need to make sure that <code>mysql</code> is fully deployed before your <code>build</code> task begins. In order to achieve this, you will use the <abbr title="(OpenShift Container Platform / OCP): an open source container application platform based on the Kubernetes container orchestrator for enterprise application development and deployment">OpenShift</abbr> Client again and wait for the <code>rollout</code> of the <code>mysql</code> <code>deploymentConfig</code> to complete after the <code>mysql-deploy</code> task. Add a sequential task after <code>mysql-deploy</code>:</p>
<p><img alt="mysql sequential task" src="../../images/Part1/mySQL_SequentialTask.png"/></p>
<p><code>Select Task</code> as <code>openshift-client</code> like before and then fill out the task with the following parameters (copy and paste boxes below image for changes):</p>
<p><img alt="mysql-check task" src="../../images/Part1/MySQLRolloutWait.png"/></p>
<p><strong>Display Name</strong></p>
<div class="highlight"><pre><span></span><code>mysql-rollout-wait
</code></pre></div>
<p><strong>ARGS</strong></p>
<div class="highlight"><pre><span></span><code>rollout
</code></pre></div>
<div class="highlight"><pre><span></span><code>status
</code></pre></div>
<div class="highlight"><pre><span></span><code>dc/mysql
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">No help please!</p>
<p>Make sure <code>help</code> is deleted from the <code>ARGS</code> section (it will be greyed out once deleted) or bad things will happen (i.e. the help screen will come up instead of the proper command running).</p>
</div>
<div class="admonition tip">
<p class="admonition-title">What the ARGS?</p>
<p>You may be wondering why you used the <code>SCRIPT</code> section in the <code>mysql-deploy</code> task for the entire command, but now are using the <code>ARGS</code> to individually list each argument of the command? Both work and so you are going through both methods here. On the one hand, the <code>SCRIPT</code> method is easier to copy and paste and looks the same as it would entered on the command line. On the other hand, the <code>ARGS</code> method adds readability to the task. Choose whichever method you prefer, though beware of input errors  with the <code>ARGS</code> method for long commands. <em>FYI: The equivalent <code>SCRIPT</code> command for the <code>mysql-rollout-wait</code> task is</em>:</p>
<div class="highlight"><pre><span></span><code>oc rollout status dc/mysql
</code></pre></div>
</div>
</li>
</ol>
<p><img alt="🎉" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f389.svg" title=":tada:"/> Now your <code>mysql-deploy</code> and <code>mysql-rollout</code> tasks will have <code>MySQL</code> alive and well for the <code>build</code> task!</p>
<h2 id="make-clean-image-from-s2i-build"><span class="enumerate-heading-plugin">7.3</span> Make Clean Image from S2I build<a class="headerlink" href="#make-clean-image-from-s2i-build" title="Permanent link">¶</a></h2>
<p>The <code>s2i-java-11</code> image is very convenient for making an image from source code. However, the simplicity that gives it value can make it fail at meeting the needs of many organizations by itself. In your case, you will take the artifacts from the s2i image and copy them to a new Docker image that can meet all your needs to get the best of both worlds. You'll create an optimized image starting from a compact <code>openj9</code> java 11 base and employing <a href="https://spring.io/blog/2020/01/27/creating-docker-images-with-spring-boot-2-3-0-m1#layered-jars" rel="noopener noreferrer" target="_blank">the advanced layers feature in spring</a> that optimizes Docker image caching with the <a href="https://raw.githubusercontent.com/ibm-wsc/spring-petclinic/main/final-Dockerfile" rel="noopener noreferrer" target="_blank">final-Dockerfile</a> in the <a href="https://github.com/ibm-wsc/spring-petclinic" rel="noopener noreferrer" target="_blank">ibm-wsc/spring-petclinic</a> git repository you forked. </p>
<ol>
<li>
<p>Add <code>Buildah</code> task</p>
<p>Add the <code>buildah</code> task as a sequential task after the <code>build</code> task.</p>
<p><img alt="Add Buildah Task" src="../../images/Part1/AddBuildahTask.png"/></p>
</li>
<li>
<p>Configure <code>buildah</code> task</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Each value that you need to configure is listed below with the value in a click-to-copy window (other values can be left alone to match the image)</p>
</div>
<p><img alt="Buildah Task Values" src="../../images/Part1/ProducingCleanImageBuildah2.png"/></p>
<p>DISPLAY NAME:
<div class="highlight"><pre><span></span><code>clean-image
</code></pre></div></p>
<p>IMAGE:
<div class="highlight"><pre><span></span><code>$(params.IMAGE_NAME)-minimal:$(params.COMMIT_SHA)
</code></pre></div></p>
<p>DOCKERFILE:
<div class="highlight"><pre><span></span><code>./final-Dockerfile
</code></pre></div></p>
<p>TLSVERIFY:
<div class="highlight"><pre><span></span><code>false
</code></pre></div></p>
<p>BUILD_EXTRA_ARGS:
<div class="highlight"><pre><span></span><code>--build-arg PETCLINIC_S2I_IMAGE=$(params.IMAGE_NAME)
</code></pre></div></p>
</li>
<li>
<p>Add <code>GIT_MESSAGE</code>, and <code>COMMIT_SHA</code> parameters to the pipeline</p>
<p>Click <code>Add Parameter</code> twice ...</p>
<p><img alt="Add Parameter" src="../../images/Part1/AddParameter.png"/></p>
<p>and then fill in the parameter details for <code>GIT_MESSAGE</code> and <code>COMMIT_SHA</code> (copy and paste boxes below image)</p>
<p><img alt="Add Image and Git Parameters" src="../../images/Part1/AddParameters.png"/></p>
<p><strong>GIT_MESSAGE</strong></p>
<p><code>GIT_MESSAGE</code> Parameter Name:
<div class="highlight"><pre><span></span><code>GIT_MESSAGE
</code></pre></div>
<code>GIT_MESSAGE</code> Parameter Description:
<div class="highlight"><pre><span></span><code>Git commit message if triggered by Git, otherwise it's a manual build
</code></pre></div>
<code>GIT_MESSAGE</code> Parameter Default Value
<div class="highlight"><pre><span></span><code>This is a manual build (not triggered by Git)
</code></pre></div></p>
<p><strong>COMMIT_SHA</strong></p>
<p><code>COMMIT_SHA</code> Parameter Name:
<div class="highlight"><pre><span></span><code>COMMIT_SHA
</code></pre></div>
<code>COMMIT_SHA</code> Parameter Description:
<div class="highlight"><pre><span></span><code>SHA of Git commit if triggered by Git, otherwise just update manual tag
</code></pre></div>
<code>COMMIT_SHA</code> Parameter Default Value:
<div class="highlight"><pre><span></span><code>manual
</code></pre></div></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Save parameters when done with entry by clicking on blue <code>SAVE</code> box before moving onto step 4. If blue <code>SAVE</code> box doesn't appear (is greyed out) delete extra blank parameters you may have accidentally added with the <code>-</code>.</p>
</div>
</li>
<li>
<p>Add workspace to <code>clean-image</code> task </p>
<ol>
<li>
<p>Save current pipeline edit and switch to <code>YAML</code> from pipeline menu.</p>
<p><img alt="Switch to yaml" src="../../images/Part1/SwitchYaml.png"/></p>
<div class="admonition info">
<p class="admonition-title">Why are you editing yaml directly?</p>
<p><code>Workspaces</code> are more versatile than traditional <code>PipelineResources</code> which is why you are using them. However, as the transition to workspaces continues, the <abbr title="(OpenShift Container Platform / OCP): an open source container application platform based on the Kubernetes container orchestrator for enterprise application development and deployment">OpenShift</abbr> Pipeline Builder doesn't support editing the <code>Workspace</code> mapping from a pipeline to a task via the Builder <abbr title="user interface">UI</abbr> so you have to do it directly in the yaml for now.</p>
</div>
</li>
<li>
<p>Find the <code>clean-image-task</code> and add the following workspace definition:</p>
<div class="highlight"><pre><span></span><code>      <span class="nt">workspaces</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">source</span>
        <span class="nt">workspace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">workspace</span>
</code></pre></div>
<p><img alt="Clean Image Workspace" src="../../images/Part1/AddWorspaceProducingCleanImage.png"/></p>
</li>
<li>
<p>Save the update</p>
<p><img alt="Save Pipeline Edit Yaml" src="../../images/Part1/PipelineUpdatedYaml.png"/></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>After the save message above appears you can then proceed to <code>Cancel</code> back to the pipeline menu.</p>
</div>
</li>
</ol>
</li>
</ol>
<h2 id="summary"><span class="enumerate-heading-plugin">7.4</span> Summary <img alt="🌒" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f312.svg" title=":waxing_crescent_moon:"/><a class="headerlink" href="#summary" title="Permanent link">¶</a></h2>
<p>Your pipeline will now automatically check that your <code>MySQL</code> instance is configured properly and rolled out before moving on to the build stage (instead of doing this as a manual task like in the previous section of the lab). Moreover, it will curate the final PetClinic (<code>minimal</code>) image to only have the necessary components instead of a bunch of extra packages (required only for the build itself) that add bloat and potential security vulnerabilities to your image. Finally, it will tag the image to distinguish between manual builds and those triggered by a potential <abbr title="updates the remote branch with local commits. You can also think of `git push` as update or publish.">git push</abbr>. In the next section, you will see this automation in action for your development environment.</p>
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p>For the purposes of this lab, you are fulfilling the requirements of a fictional organization. These requirements could change for your specific organization but would follow a similar pattern with different specifics. <a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a class="md-footer__link md-footer__link--prev" href="../configure_overview/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Configure Pipeline Overview
            </div>
</div>
</a>
<a class="md-footer__link md-footer__link--next" href="../runpipeline/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Configure Development Deployment
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
          Material for MkDocs
        </a>
</div>
<div class="md-footer-social">
<a class="md-footer-social__link" href="https://github.com/ibm-wsc" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
<a class="md-footer-social__link" href="https://hub.docker.com/u/s390x" rel="noopener" target="_blank" title="hub.docker.com">
<svg viewbox="0 0 640 512" xmlns="http://www.w3.org/2000/svg"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
<script src="../../assets/javascripts/bundle.a1c7c35e.min.js"></script>
</body>
</html>